# fortran简介和控制流
## Fortran的基本特性
- fortran不区分大小写
- 代码命令之间的空格没有任何意义
- 块的封装有三种方法，以`program`为例
    - `end`
    - `end program`
    - `end program name`
    - 程序名的第一个字符必须是字母，其他字符还可以是数字和下划线
- 运算优先级
    - 圆括号，且内层圆括号比外层优先
    - 从左到右指数运算
    - 从左到右乘除
    - 从左到右加减
### 书面格式
- 固定格式
    - 是f90之前的写法
    - 每行的前6个字符被占用
    - 第一个字符如果是`C`、`c`或者星号`*`，这一行被注释
    - 1~5个字符如果是数字表明这一行被编号
    - 第6个字符如果是0以外的任何字符表明这一行接续上一行
    - 7~72个字符是Fortran代码的编写区，超出会忽略或者报错
- 自由格式
    - `!`后面的文本都是注释
    - 每行可以编写132个字符
    - 一行代码最后接符号`&`表明接续下一行，如果开头有`&`表明接续上一行。一条语句最多可以写40(256 for F03)行
### 数据类型
Fortran变量第一个字符必须是字母，其他字符可以由字母数字和下划线组成。

- 整数
    - 长整型
        - 声明`integer(kind=4) a`
    - 短整型
        - 声明`integer(kind=2) a`
    - `B"10"`二进制常量,`O"10"`八进制常量，`Z"10"`十六进制常量
    - `42_long`说明是长整型整数常量，`42_short`是短整型
- 浮点数
    - 单精度
        - 声明`real(kind=4) a`
    - 双精度
        - 声明`real(kind=8) a`
    - `3.0_double`为单精度浮点数常量，`3.0_quad`为双精度（此处存疑）
    - 注意浮点数和整数的混合运算过程中，只有当浮点数和整数出现在同一个操作中，才会将整数转换为浮点数运算。
- 复数
    - 由两个浮点数来表示`complex`
    - 实部和虚部的kind类型必须一致
- 字符
    - 一个字符串常数是由单引号或者双引号括住的字符串
    - 声明需要给定最大长度`character(len=10) a`，如果整个圆括号缺省则为单个字符
    - `string(a:b)="...."`可以重置第a个字符到第b个字符(从1开始计算)
    - 如果赋值时小于最大长度，字符串末尾为空格，如果大于则忽略大于的部分。
    - 字符串可以通过`//`连接
    - 常用函数
        - `len(string)`返回输入字符串的声明长度，返回值为整型
        - `len_trim(string)`返回除去尾部空格后的实际长度
        - `index(string,substring)`返回子串在母串中第一次出现的位置
- 逻辑判断
    - 声明`logical a`
    - 值`.true.`和`.false.`
- 自定义数据类型

```fortran
type :: person
  character(len=30) :: name
  integer :: age
end type person  !定义

type(person) :: a !声明
write(*,*) a%age !访问
```

自定义数据类型不一定要一个一个数据设置，可以通过`a=person("Peter",30)`这种形式赋值。
## 基本IO功能
### 输出
`write(*,*) "hello world"`，严谨的写法是`write(UNIT=*,FMT=*) "hello world"`，星号表示默认，前一个表输出位置，后一个表输出格式，输出到屏幕还可以将第一个星号替换成6。

变量和字符串混合输出的时候需要用逗号隔开。

每次执行`write`命令后会自动切换到下一行，输出单/双引号需要打两次单/双引号。

`print`命令类似，不同是可以省略括号和第一个星号

当设置的输出文本框不足会输出星号
### 输入
```fortran
read(*,*) a
read(5,*) a,b,c ! 键盘输入用,或者空格或者enter分割
read(unit=5,fmt=*) a
```
键盘输入位置为5

注意字符串的输入，如果不指定`fmt`，那么在读到第一个空白字符的时候就会停止，把后面的内容（包括空白字符）舍弃，只读取到空白字符前面的内容。这点和c语言中的`scanf`有某种程度上的不同。

当输入逻辑变量时，输入的值必须以T或者F开头，只要输入的第一个字符是T或者F，逻辑变量就会被认定。
### 格式化输入输出
格式化输入方式，在`fmt`给定行代码，行代码所在行给出格式命令`format()`。或者直接在`fmt`处给出格式命令内容的字符串如`"(1X,I5)"`

格式命令中可以包含字符串，作为默认的输入输出。

格式命令中的第一个参数可以是所谓的控制字符，控制字符可以控制打印的行为：
- `'1'`，输出时跳到新页
- `' '`, 输出时单行间距（缺省）
- `'0'`, 双行间距
- `'+'`，没有间距（在前一行上打印）
- 在打印第一行时，最好指定控制字符，不然可能出现不在预期中的行为。
- **注意这个特性在Fortran 2003标准中删除，因为最初是为了行式打印机设计的**

常见的格式命令：
- 以固定宽度输出对应数据类型的数
    - 整数`Iw[.b]` w宽度，至少输出b个数字（不足补0）
    - 浮点数`Fw[.b]` w宽度，小数保留b位。(伪)科学计数法`Ew.b[Ec]` w宽度，小数占b位，指数占c位。
    - 字符串`Aw` w宽度
    - 逻辑值`Lw` w宽度
    - 科学计数法`ESw.b`w宽度，小数占b位
    - 使用G可以输出所有类型的数据
    - 如果对多个数值重复使用同一种格式输出，可以简单地在`I,F,A,L`前加重复的次数
- 换行输出`/`
- 输出位置右移n位`nX`
- 取消结尾换行符`$`
## 声明
- 变量的声明必须在出现数值计算或者输入输出之前
- `implicit none`接在`program`命令的下一行，关闭默认类型，这样所有变量都需要声明
- 声明时如果要初始化或者使用形容词，不能省略双冒号`real, parameter ::pi=3.1415`

声明常数需要用形容词`parameter`修饰。对于字符串常数初始化，可以省略`(len=<len>)`

Fortran90之前的版本如果要设置初值需要使用`DATA`命令，`DATA A,B,C,STR /1,2.0,(3.0,4.0),'FORTRAN'/`，按照顺序依次赋值

等价声明，`equivalence(a,b)`两个变量共用内存上的数值。
## 控制流
### if语句
```fortran
if () then statement

if () then

end if


if () then

else

end if


[name:] if () then

else if () then

else if () then

else

end if [name]
```
### 逻辑判断与运算
|             | fortran90 | fortran77 |
| :---------: | :-------: | :-------: |
|   判断相等   |   `==`    |  `.EQ.`   |
|  判断不相等  |   `/=`    |  `.NE.`   |
|   判断大于   |    `>`    |  `.GT.`   |
| 判断大于等于 |   `>=`    |  `.GE.`   |
|   判断小于   |    `<`    |  `.LT.`   |
| 判断小于等于 |   `<=`    |  `.LE.`   |

逻辑运算`.AND.`，`.OR.`，`.NOT.`，`.EQV.`，`.NEQV.`

二进制运算库函数`iand(a,b)`和`ior(a,b)`

当表达式中出现逻辑运算时，运算的顺序为：
- 先计算所有的算数表达式
- 所有关系运算符从左往右计算
- 所有的`.NOT.`运算
- 所有的`.AND.`从左往右计算
- 所有的`.OR.`从左往右计算
- 所有的`.EQV.`和`.NEQV.`从左往右计算
### SELECT CASE语句
```fortran
select case(变量)
case (value1)

case (value2:value3) !变量>=value2且<=value3时执行

case (value4,value5,value6)

case default

end select
```
`case`中不能用变量
### GOTO
`goto 100`跳转到行编号100
### PAUSE, CONTINUE, STOP
`continue`功能是继续向下执行程序，并没有实际用处，和c语言不同
### 循环
循环可以署名，在循环前标明`name:`，结束时需要加上名字`end do name`。
#### DO
```fortran
! fortran90风格
do counter=1, end, 1


end do
! fortran77风格
      do 100, counter=1, limit, 1

100   ...! 循环到此结束
```
当`counter<=end`时执行，每次`counter`递增1，可以省略。当然增量也可以是负数，但是此时循环截止条件就会自动转变。

与c语言不同，作为计数器变量的值，在循环过程中不能再用命令改变其数值，不然编译的时候会报错。
#### DO WHILE循环
```fortran
do while (逻辑运算)

end do
```

和c中的while用法一样，都是先判断再进入循环体。
#### 控制命令
`cycle`相当于c中的`continue`。

`exit`命令退出当前正在执行的循环（注意如果`exit`在嵌套中，退出的是最内层的）

`cycle`和`exit`后面可以加上循环名称表明是对哪层循环操作。